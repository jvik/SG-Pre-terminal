<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Record Income and Expenses</title>
    <status>drafted</status>
    <generatedAt>2025-12-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-record-income-and-expenses.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to add new income and expense entries</iWant>
    <soThat>I can keep an accurate record of my finances.</soThat>
    <tasks>
      <task id="1" parent="" ac="3">Implement Backend API for Transactions</task>
      <task id="1.1" parent="1" ac="">Define the `transactions` table model as per the tech spec. (Note: To be implemented via Supabase client, following the pattern from Story 2.1).</task>
      <task id="1.2" parent="1" ac="">Create Pydantic schemas for transaction data within the endpoint file.</task>
      <task id="1.3" parent="1" ac="">Create a `POST /api/v1/transactions` endpoint in a new `excelence/backend/app/api/v1/endpoints/transactions.py` file.</task>
      <task id="1.4" parent="1" ac="">Secure the endpoint using the existing authentication dependency (`app/api/deps.py`).</task>
      <task id="1.5" parent="1" ac="">Ensure all database operations are strictly scoped to the authenticated user.</task>
      <task id="1.6" parent="1" ac="">Add unit tests for the new endpoint in `excelence/backend/tests/api/v1/test_transactions.py`.</task>
      <task id="2" parent="" ac="1, 2, 4">Implement Frontend UI for Adding Transactions</task>
      <task id="2.1" parent="2" ac="">Create a reusable `TransactionForm.svelte` modal component.</task>
      <task id="2.2" parent="2" ac="">Add a button to the main dashboard to open the transaction modal.</task>
      <task id="2.3" parent="2" ac="">The form's category dropdown must be populated by fetching data from the `/api/v1/categories` endpoint.</task>
      <task id="2.4" parent="2" ac="">Integrate the form with the `POST /api/v1/transactions` endpoint using the `api.ts` service.</task>
      <task id="2.5" parent="2" ac="">Ensure the UI updates reactively after a new transaction is successfully added.</task>
      <task id="2.6" parent="2" ac="">Add component tests for the `TransactionForm.svelte` component.</task>
    </tasks>
  </story>

  <acceptanceCriteria>
      <criterion id="1">**Given** a user is on the main dashboard</criterion>
      <criterion id="2">**When** they open the "Add Transaction" form and enter an amount, select a category, and a date for an income or expense</criterion>
      <criterion id="3">**Then** a new record is created in the `transactions` table in the database.</criterion>
      <criterion id="4">**And** the main dashboard immediately updates to reflect the new entry.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs><doc>
        <path>docs/PRD.md</path>
        <title>Excelence Product Requirements Document (PRD)</title>
        <section>FR003</section>
        <snippet>Users must be able to create, read, update, and delete income and expense entries.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Core Financial Management</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /: Creates a new income or expense transaction.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Excelence: Decision Architecture Document</title>
        <section>API Design &amp; Communication</section>
        <snippet>The API will adhere to a standardized JSON response format (JSend-style).</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification: Excelence</title>
        <section>Core Loop: Transaction Management</section>
        <snippet>An existing user logs in, adds a new expense, and views it in the spreadsheet.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 2.2: Record Income and Expenses</section>
        <snippet>As a user, I want to add new income and expense entries, so that I can keep an accurate record of my finances.</snippet>
      </doc></docs>
    <code><artifact>
        <path>excelence/backend/app/api/deps.py</path>
        <kind>dependency</kind>
        <symbol>get_current_user</symbol>
        <reason>To be used to secure the new transaction endpoints.</reason>
      </artifact>
      <artifact>
        <path>excelence/frontend/src/lib/services/api.ts</path>
        <kind>service</kind>
        <symbol>api.post</symbol>
        <reason>To be used by the frontend to send new transaction data to the backend.</reason>
      </artifact></code>
    <dependencies><dependency ecosystem="node">
        <package>svelte</package>
        <version>^5.43.8</version>
      </dependency>
      <dependency ecosystem="node">
        <package>@sveltejs/kit</package>
        <version>^2.48.5</version>
      </dependency>
      <dependency ecosystem="node">
        <package>tailwindcss</package>
        <version>^4.1.17</version>
      </dependency>
      <dependency ecosystem="python">
        <package>fastapi</package>
        <version>&gt;=0.115.0</version>
      </dependency>
      <dependency ecosystem="python">
        <package>pydantic</package>
        <version>&gt;=2.0</version>
      </dependency>
      <dependency ecosystem="python">
        <package>supabase</package>
        <version>==2.5.0</version>
      </dependency></dependencies>
  </artifacts>

  <constraints><constraint>Reuse the robust, header-based authentication dependency established in Story 2.1, located at `excelence/backend/app/api/deps.py`.</constraint>
      <constraint>All database queries must be filtered by `user_id` to prevent data leakage between users.</constraint>
      <constraint>The frontend implementation should ensure that upon successful creation of a transaction, the main dashboard's transaction list and any financial summaries update instantly without requiring a page reload.</constraint>
      <constraint>The form should gracefully handle and display any validation errors returned from the API (e.g., invalid amount, missing category).</constraint></constraints>
  <interfaces><interface>
        <name>Create Transaction</name>
        <kind>REST endpoint</kind>
        <signature>POST /api/v1/transactions</signature>
        <path>excelence/backend/app/api/v1/endpoints/transactions.py</path>
      </interface>
      <interface>
        <name>Get Categories</name>
        <kind>REST endpoint</kind>
        <signature>GET /api/v1/categories</signature>
        <path>excelence/backend/app/api/v1/endpoints/categories.py</path>
      </interface></interfaces>
  <tests>
    <standards><standards>Backend unit tests should be created for new endpoints. Frontend component tests should be created for new components.</standards></standards>
    <locations><location>excelence/backend/tests/api/v1/</location>
      <location>excelence/frontend/src/lib/components/shared/</location></locations>
    <ideas><idea ac="3">Add unit tests for the new endpoint in `excelence/backend/tests/api/v1/test_transactions.py`.</idea>
      <idea ac="1, 2, 4">Add component tests for the `TransactionForm.svelte` component.</idea></ideas>
  </tests>
</story-context>
