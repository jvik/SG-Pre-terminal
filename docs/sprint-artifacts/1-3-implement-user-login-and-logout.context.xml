<?xml version="1.0" encoding="UTF-8"?>
<story-context>
    <story>
        <id>1.3</id>
        <title>Implement User Login and Logout</title>
        <as-a>a registered user</as-a>
        <i-want>to log in with my email and password and be able to log out</i-want>
        <so-that>I can securely access my financial data and end my session</so-that>
    </story>
    <acceptance-criteria>
        <criterion>Given a registered user is on the login page</criterion>
        <criterion>When they enter their correct credentials and submit the form</criterion>
        <criterion>Then the system validates their credentials and returns a JWT token</criterion>
        <criterion>And the user is redirected to the main dashboard.</criterion>
        <criterion>When a logged-in user clicks the "Logout" button</criterion>
        <criterion>Then their session is terminated and they are redirected to the login page.</criterion>
    </acceptance-criteria>
    <tasks>
        <task>Implement `POST /api/v1/auth/login` endpoint in the backend. (AC: 3)</task>
        <task>Create a login form in the frontend. (AC: 1, 2)</task>
        <task>Implement post-login and logout flow. (AC: 4, 5, 6)</task>
    </tasks>
    <artifacts>
        <docs>
            <doc>
                <path>docs/epics.md</path>
                <title>ibe160 - Epic Breakdown</title>
                <section>Story 1.3: Implement User Login and Logout</section>
                <snippet>As a registered user, I want to log in with my email and password and be able to log out, so that I can securely access my financial data and end my session.</snippet>
            </doc>
            <doc>
                <path>docs/architecture.md</path>
                <title>Excelence: Decision Architecture Document</title>
                <section>3.3. State Management (Frontend)</section>
                <snippet>We will use Svelte's built-in stores (writable, readable). Rationale: Svelte stores are lightweight, idiomatic, and perfectly sufficient for the complexity of this application.</snippet>
            </doc>
            <doc>
                <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
                <title>Epic Technical Specification: Project Foundation &amp; User Authentication</title>
                <section>APIs and Interfaces</section>
                <snippet>Endpoint: POST /api/v1/auth/login. Authenticates a user and returns a JWT token.</snippet>
            </doc>
        </docs>
        <code-references>
            <code-reference>
                <path>excelence/backend/app/api/v1/endpoints/auth.py</path>
                <kind>controller</kind>
                <symbol>router.post("/login")</symbol>
                <reason>Primary location for implementing the login endpoint.</reason>
            </code-reference>
            <code-reference>
                <path>excelence/backend/app/core/security.py</path>
                <kind>service</kind>
                <symbol>verify_password, create_access_token</symbol>
                <reason>Contains helper functions for password verification and JWT creation.</reason>
            </code-reference>
            <code-reference>
                <path>excelence/backend/app/crud/crud_user.py</path>
                <kind>data-access</kind>
                <symbol>get_user_by_email</symbol>
                <reason>Needed to retrieve a user from the database for authentication.</reason>
            </code-reference>
            <code-reference>
                <path>excelence/frontend/src/routes/login/+page.svelte</path>
                <kind>component</kind>
                <symbol>handleLogin</symbol>
                <reason>The UI component for the login form.</reason>
            </code-reference>
            <code-reference>
                <path>excelence/frontend/src/lib/stores/auth.ts</path>
                <kind>store</kind>
                <symbol>authStore</symbol>
                <reason>Svelte store for managing the user's authentication state and JWT token.</reason>
            </code-reference>
            <code-reference>
                <path>excelence/frontend/src/lib/services/api.ts</path>
                <kind>service</kind>
                <symbol>login</symbol>
                <reason>Central service for making API calls to the backend.</reason>
            </code-reference>
        </code-references>
        <dependencies>
            <dependency ecosystem="python">
                <package>fastapi</package>
                <version>0.104.1</version>
            </dependency>
            <dependency ecosystem="python">
                <package>python-jose[cryptography]</package>
                <version>3.3.0</version>
            </dependency>
            <dependency ecosystem="python">
                <package>passlib[bcrypt]</package>
                <version>1.7.4</version>
            </dependency>
            <dependency ecosystem="npm">
                <package>svelte</package>
                <version>^5.43.8</version>
            </dependency>
            <dependency ecosystem="npm">
                <package>@sveltejs/kit</package>
                <version>^2.48.5</version>
            </dependency>
        </dependencies>
    </artifacts>
    <interfaces>
        <interface>
            <name>User Login</name>
            <kind>REST</kind>
            <signature>POST /api/v1/auth/login</signature>
            <path>excelence/backend/app/api/v1/endpoints/auth.py</path>
        </interface>
    </interfaces>
    <constraints>
        <constraint>Use JWT token-based authentication.</constraint>
        <constraint>Use Svelte's built-in stores for frontend state management.</constraint>
        <constraint>API responses should follow the JSend-style format.</constraint>
        <constraint>All dates and times will be stored in the database in UTC format.</constraint>
    </constraints>
    <tests>
        <standards>The previous story encountered issues with `pytest` setup, which needs to be resolved. Unit tests for the backend and component tests for the frontend are required.</standards>
        <locations>
            <location>excelence/backend/tests</location>
            <location>excelence/frontend/src/routes/login</location>
        </locations>
        <ideas>
            <idea for_ac="3">Test the login endpoint with valid credentials.</idea>
            <idea for_ac="3">Test the login endpoint with invalid credentials.</idea>
            <idea for_ac="1,2">Test that the login form correctly calls the API.</idea>
            <idea for_ac="4">Test that the user is redirected to the dashboard on successful login.</idea>
            <idea for_ac="5,6">Test that the logout button clears the user's session and redirects to the login page.</idea>
        </ideas>
    </tests>
</story-context>
